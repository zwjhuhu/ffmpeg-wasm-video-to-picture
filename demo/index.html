<!DOCType html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ffmpeg wasm视频逐帧绘制</title>
    <style>
        input,label,p {font-size:16px}
        body {margin: 20px}
        @media (max-width: 700px) {input{display:block;margin-bottom:15px}}
    </style>
</head>
<body>
<form style="margin-bottom: 20px;">
    <p>请选择一个视频（本地操作不会上传）</p>
    <input type="file" required name="file"/>
	decodeAvg: <input id="decodeAvg" type="text" readonly="readonly"/>
	drawAvg: <input id="drawAvg" type="text" readonly="readonly"/>
</form>
<p id="text-tip">WASM下载解析中，请稍候。。。<br>（解析需约5s，手机上需要的时间较长，可先选择一个视频文件）</p>
<div id="error-tip"></div>
<canvas width="600" height="400" id="canvas"></canvas>
<script src="index.js"></script>
<script>
!function() {
    let setFile = null;
	let clearFile = null;
	let findFrame = null;
    let $text = document.querySelector('#text-tip'),
        $errorTip = document.querySelector('#error-tip');
	let $decodeAvg = document.getElementById('decodeAvg');
	let $drawAvg = document.getElementById('drawAvg');
    if (!window.WebAssembly) {
        let tip = '你的浏览器不支持WASM!';
        if (/iPhone|iPad/.test(window.navigator.userAgent)) {
            tip += ' ios需要11以上版本'
        }
        $text.textContent = tip;
        return;
    }
    let form = document.querySelector('form');
    Module.onRuntimeInitialized = function () {
        setFile = Module.cwrap('setFile', 'number', ['number', 'number']);
		clearFile = Module.cwrap('clearFile');
		findFrame = Module.cwrap('findFrame');
        $text.textContent = 'WASM初始化完毕，请选择视频文件';
        setTimeout(() => $text.remove(), 3000);
        console.log('WASM initialized done!');
        if (form.file.value) {
            process();
        }
        // console.log(setFile(5));
    };
    form.file.onchange = process;
	
	let fileData = 0;
	let testDraw;
	// 性能分析用
	window.decodeTimes = [];
	window.drawTimes = [];
	
    function process (event) {
        if (!form.file.value) {
            return;
        }
        event && event.preventDefault();
        let fileReader = new FileReader();
        fileReader.onload = function () {
            if (!setFile) {
                // alert('WASM未加载解析完毕，请稍候');
                // form.file.value = '';
                return;
            }
            // console.log(buffer.length);
            // console.log(buffer);
            // let ptr = setFile(buffer, buffer.length);
            // console.log(offset);
            let ptr = 0;
            
            try {
                let buffer = new Uint8Array(this.result);
                fileData = Module._malloc(buffer.length);
                //console.log(offset);
                Module.HEAP8.set(buffer, fileData);
                //ptr = setFile(offset, buffer.length);
				if(!setFile(fileData, buffer.length)){
					clearFile();
					return;
				}
            } catch (e) {
                $errorTip.innerHtml = 'oh, no! 不小心挂了，请刷新页面重试';
                throw e;
            }
			let count = 0;
			let timer = null;
			
			let tick = Math.floor(1000/24);
			testDraw = function(){
				let elipse = performance.now();
				let diff = elipse - lastTime;
				if (diff < tick - 10){
					window.clearTimeout(timer);
					timer = window.setTimeout(testDraw,Math.floor(tick - diff));
					return ;
				}
				let startTime = performance.now();
				let ptr = findFrame();
				let checkTime = performance.now();
				window.decodeTimes.push(checkTime - startTime);
				$decodeAvg.value = window.decodeTimes.reduce((sum,val)=>{sum+=val;return sum;},0)/window.decodeTimes.length;
				
				if (ptr) {
					let offset = ptr / 4,
					width = Module.HEAPU32[offset],
					height = Module.HEAPU32[offset + 1],
					imgBufferPtr = Module.HEAPU32[offset + 2],
					imageBuffer = Module.HEAPU8.subarray(imgBufferPtr, imgBufferPtr + width * height * 3);
					if (!width || !height) {
						$errorTip.textContent = '获取图片帧失败，图片宽高为0，时间可能超限';
						window.clearTimeout(timer);
						return;
					}
					startTime = performance.now();
					drawImage(width,height,imageBuffer);
					checkTime = performance.now();
					window.drawTimes.push(checkTime - startTime);
					$drawAvg.value = window.drawTimes.reduce((sum,val)=>{sum+=val;return sum;},0)/window.drawTimes.length;
					Module._free(imgBufferPtr);
					Module._free(ptr);
				}
				if (!ptr) {
					Module._free(fileData);
				}else {
					window.clearTimeout(timer);
					let nextTime = tick - (performance.now() - lastTime);
					if (nextTime < 0){
						nextTime = 0;
					}
					lastTime = elipse;
					timer = window.setTimeout(testDraw,Math.floor(nextTime));
				}
			};
			
			timer = window.setTimeout(testDraw,100);
			let lastTime = performance.now();
        };
        // console.log(form.file.files[0]);
        let file = form.file.files[0];
        if (file.type && file.type.indexOf('video') !== 0) {
            $errorTip.textContent = '您选择的类型是：' + file.type + '不是一个视频文件';
            return;
        }
        $errorTip.textContent = '';
        fileReader.readAsArrayBuffer(file);
    };
    // 内存画布
    let memCanvas = document.createElement('canvas'),
        memContext = memCanvas.getContext('2d');
    let canvas = document.querySelector('#canvas'),
        ctx = canvas.getContext('2d');
    //canvas.width = Math.max(600, window.innerWidth - 40);
	//canvas.width=1280;
	canvas.height=720;
    function drawImage(width, height, buffer) {
        let imageData = ctx.createImageData(width, height);
        let k = 0;
        for (let i = 0; i < buffer.length; i++) {
            if (i && i % 3 === 0) {
                imageData.data[k++] = 255;
            }
            imageData.data[k++] = buffer[i];
        }
        imageData.data[k] = 255;
        memCanvas.width = width;
        memCanvas.height = height;
        //canvas.height = canvas.width * height / width;
		canvas.width = canvas.height * width / height;
        memContext.putImageData(imageData, 0, 0, 0, 0, width, height);
        ctx.drawImage(memCanvas, 0, 0, width, height, 0, 0, canvas.width, canvas.height);
		//ctx.putImageData(imageData, 0, 0, 0, 0, width, height);
		
    }
	
	
}();
</script>
</body>
</html>
